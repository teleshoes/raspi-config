#!/usr/bin/perl
use strict;
use warnings;

my $IPMAGIC_NAME = "raspi";

my @packagesToRemove = (
  "libtag1-rusxmms",
  "wolfram-engine",  #deps: libxcb-cursor0 pi-language-support
);

my $normalPackages = {
  '1' => [qw(
    vim-gtk rsync wget git openvpn screen
  )],
  '2' => [qw(
    libterm-readkey-perl libtext-csv-perl libts0
  )],
  '3' => [qw(
    x11vnc lsof psmisc zip unzip parted
    fonts-droid-fallback fonts-vlgothic
    fonts-opensymbol fonts-liberation fonts-linuxlibertine
    fonts-sil-gentium fonts-sil-gentium-basic
    fonts-inconsolata
  )],
  '4' => [qw(
    xinit midori time streamer
  )],
  '5' => [qw(
    mplayer mpv man python-pip alsa-utils xdotool unclutter xscreensaver
  )],
  '6' => [qw(
    libcec4 libcec-dev
  )],
};

sub runRemote(@){
  my @cmd = ("ipmagic", $IPMAGIC_NAME, "-u", "root", @_);
  system @cmd;
  die "error running '@cmd'\n" if $? != 0;
}

sub installPackages($);

sub main(@){
  my $arg = shift;
  $arg = 'all' if not defined $arg;
  my $valid = join '|', qw(all packages remove);
  if(@_ > 0 or $arg !~ /^($valid)/){
    die "Usage: $0 TYPE {type must start with one of: $valid}\n";
  }
  installPackages($normalPackages) if $arg =~ /^(all|packages)/;
  runRemote("apt remove @packagesToRemove") if $arg =~ /^(all|remove)/;
}


sub installPackages($){
  my $pkgGroups = shift;
  print "\n\n";
  for my $pkgGroup(sort keys %$pkgGroups){
    my @packages = @{$$pkgGroups{$pkgGroup}};
    print "\n\nInstalling group[$pkgGroup]:\n----\n@packages\n----\n";
    runRemote ''
      . "yes |"
      . " apt-get install"
      . " -y --allow-unauthenticated"
      . " @packages";
  }
}

&main(@ARGV);
