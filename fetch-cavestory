#!/usr/bin/perl
use strict;
use warnings;
use File::Basename qw(basename);

my $IPMAGIC_NAME = "raspi";
my $USER = "pi";

my $LOCAL_SAVE_DIR = "$ENV{HOME}/Code/raspi/backup/cavestory-saves";
my $REMOTE_SAVE_DIR = "/home/$USER/.local/share/nxengine";

my $EXEC = basename $0;

my $USAGE = "Usage:
  $EXEC -h|--help
    show this message

  $EXEC backup
    copy remote $REMOTE_SAVE_DIR/profile*.dat to local $LOCAL_SAVE_DIR/

  $EXEC restore
    copy local $LOCAL_SAVE_DIR/* to remote $REMOTE_SAVE_DIR/
";

my $CMD_BACKUP = "backup";
my $CMD_RESTORE = "restore";

sub main(@){
  my $cmd = undef;
  while(@_ > 0){
    my $arg = shift;
    if($arg =~ /^(-h|--help)$/){
      print $USAGE;
      exit 0;
    }elsif($arg =~ /^(backup)$/){
      $cmd = $CMD_BACKUP;
    }elsif($arg =~ /^(restore)$/){
      $cmd = $CMD_RESTORE;
    }else{
      die "ERROR: unknown arg $arg\n";
    }
  }

  die $USAGE if not defined $cmd;

  if($cmd eq $CMD_BACKUP){
    system "ipmagic", $IPMAGIC_NAME, "-u", $USER, "--rsync",
      "-avP",
      "--mkpath",
      ":$REMOTE_SAVE_DIR/profile*.dat",
      "$LOCAL_SAVE_DIR/latest/"
    ;
  }elsif($cmd eq $CMD_RESTORE){
    system "ipmagic", $IPMAGIC_NAME, "-u", $USER, "--rsync",
      "-avP",
      "$LOCAL_SAVE_DIR/latest/",
      ":$REMOTE_SAVE_DIR/",
    ;
  }else{
    die "ERROR: unknown command $cmd\n";
  }
}

&main(@ARGV);
